<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar producto exclusivo {{ producto.id }} - ShopFusion</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
  <header class="admin-header">
    <h1>Editar producto exclusivo #{{ producto.id }}</h1>
    <a href="{{ url_for('listar_productos_exclusivos') }}" class="btn-volver">‚Üê Volver a lista de exclusivos</a>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container">
        {% for category, message in messages %}
          <p class="flash flash-{{ category }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main>
    <form method="POST" class="form-admin">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <!-- ID solo lectura -->
      <div class="form-group">
        <label>ID</label>
        <input type="text" value="{{ producto.id }}" disabled>
      </div>

      <!-- T√≠tulo -->
      <div class="form-group">
        <label for="titulo">T√≠tulo</label>
        <input type="text" id="titulo" name="titulo" value="{{ producto.titulo }}" required>
      </div>

      <!-- Descripci√≥n -->
      <div class="form-group">
        <label for="descripcion">Descripci√≥n</label>
        <textarea id="descripcion" name="descripcion" rows="4" required>{{ producto.descripcion }}</textarea>
      </div>

      <!-- Precio Proveedor -->
      <div class="form-group">
        <label for="precio_proveedor">Precio Proveedor *</label>
        <input
          type="number"
          step="0.01"
          min="0"
          id="precio_proveedor"
          name="precio_proveedor"
          value="{{ producto.precio_proveedor or 0 }}"
          required
        >
        <small style="color: #666; display: block; margin-top: 0.25rem;">Precio al que compras el producto al proveedor</small>
      </div>

      <!-- Precio -->
      <div class="form-group">
        <label for="precio">Precio de Venta *</label>
        <input
          type="number"
          step="0.01"
          min="0"
          id="precio"
          name="precio"
          value="{{ producto.precio }}"
          required
        >
        <small style="color: #666; display: block; margin-top: 0.25rem;">Precio al que vendes el producto</small>
      </div>

      <!-- Precio oferta -->
      <div class="form-group">
        <label for="precio_oferta">Precio con Descuento (opcional)</label>
        <input
          type="number"
          step="0.01"
          min="0"
          id="precio_oferta"
          name="precio_oferta"
          value="{{ producto.precio_oferta or '' }}"
        >
        <small style="color: #666; display: block; margin-top: 0.25rem;">Precio final con descuento (si hay oferta)</small>
      </div>
      <!-- Link proveedor -->
      <div class="form-group">
        <label for="link_proveedor">Link del proveedor (solo admin)</label>
        <input
          type="url"
          id="link_proveedor"
          name="link_proveedor"
          value="{{ producto.link_proveedor or '' }}"
          placeholder="https://ejemplo.com/producto-proveedor"
        >
        {% if producto.link_proveedor %}
          <small style="display: block; margin-top: 0.25rem;">
            <a href="{{ producto.link_proveedor }}">Ver link del proveedor</a>
          </small>
        {% else %}
          <small style="display: block; margin-top: 0.25rem; color: #666;">Sin link asignado.</small>
        {% endif %}
      </div>
      
      <!-- Informaci√≥n de Margen -->
      <div class="form-group" id="margen-info" style="padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6; display: none;">
        <strong style="color: #1e40af;">üìä Informaci√≥n de Margen:</strong>
        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
          <div>Margen de Ganancia: <strong id="margen-valor" style="color: #10b981;">$0.00</strong></div>
          <div>Ganancia Admin (50%): <strong id="ganancia-admin" style="color: #3b82f6;">$0.00</strong></div>
          <div>Comisi√≥n Afiliado (50%): <strong id="comision-afiliado" style="color: #ff5f1f;">$0.00</strong></div>
        </div>
      </div>

      <!-- Categor√≠a -->
      <div class="form-group">
        <label for="categoria">Categor√≠a</label>
        <select id="categoria" name="categoria">
          <option value="">Selecciona una categor√≠a</option>
          {% for cat in categorias %}
            <option value="{{ cat }}" {% if producto.categoria == cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Stock -->
      <div class="form-group">
        <label for="stock">Stock</label>
        <input
          type="number"
          min="0"
          id="stock"
          name="stock"
          value="{{ producto.stock }}"
        >
      </div>

      <!-- Im√°genes: preview -->
      <div class="form-group">
        <label>Im√°genes actuales</label>
        {% if producto.imagenes %}
          <div class="imagenes-preview">
            {% for img in producto.imagenes %}
              <div class="img-thumb">
                <img src="{{ img }}" alt="Imagen de {{ producto.titulo }}" loading="lazy">
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="help-text">Este producto a√∫n no tiene im√°genes registradas.</p>
        {% endif %}
      </div>

      <!-- Im√°genes: edici√≥n de URLs -->
      <div class="form-group">
        <label for="imagenes">Im√°genes (URLs separadas por comas)</label>
        <textarea
          id="imagenes"
          name="imagenes"
          rows="3"
          placeholder="https://ejemplo1.jpg, https://ejemplo2.png"
        >{% if producto.imagenes %}{{ producto.imagenes | join(', ') }}{% endif %}</textarea>
        <p class="help-text">
          Escribe una o varias URLs completas separadas por comas.
          La primera se usar√° como imagen principal en la web.
        </p>
      </div>

      <!-- Estado -->
      <div class="form-group">
        <label for="estado">Estado</label>
        <select id="estado" name="estado">
          <option value="activo"   {% if producto.estado == 'activo' %}selected{% endif %}>Activo</option>
          <option value="inactivo" {% if producto.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
          <option value="borrador" {% if producto.estado == 'borrador' %}selected{% endif %}>Borrador</option>
        </select>
      </div>

      <button type="submit" class="btn-primario">Guardar cambios</button>
    </form>
  </main>
  
  <script>
    function calcularMargen() {
      const precioProveedor = parseFloat(document.getElementById('precio_proveedor').value) || 0;
      const precioOferta = parseFloat(document.getElementById('precio_oferta').value) || 0;
      const precio = parseFloat(document.getElementById('precio').value) || 0;
      
      const precioFinal = precioOferta > 0 && precioOferta < precio ? precioOferta : precio;
      const margen = precioFinal - precioProveedor;
      const gananciaAdmin = margen * 0.5;
      const comisionAfiliado = margen * 0.5;
      
      const margenInfo = document.getElementById('margen-info');
      if (precioProveedor > 0 && precioFinal > precioProveedor) {
        document.getElementById('margen-valor').textContent = '$' + margen.toFixed(2);
        document.getElementById('ganancia-admin').textContent = '$' + gananciaAdmin.toFixed(2);
        document.getElementById('comision-afiliado').textContent = '$' + comisionAfiliado.toFixed(2);
        margenInfo.style.display = 'block';
      } else {
        margenInfo.style.display = 'none';
      }
    }
    
    document.getElementById('precio_proveedor').addEventListener('input', calcularMargen);
    document.getElementById('precio').addEventListener('input', calcularMargen);
    document.getElementById('precio_oferta').addEventListener('input', calcularMargen);
    calcularMargen(); // Calcular al cargar
  </script>
</body>
</html>
